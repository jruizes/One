var map;var latlng_street=[];var latlng_metro=[];var infoRouteHash={};var buses_hash={};var overlay_buses_hash={};var init_lat;var init_lng;var end_lat;var end_lng;var size_infoHash;function windowHeight(){if(self.innerHeight)return self.innerHeight;if(document.documentElement&&document.documentElement.clientHeight)return y=document.documentElement.clientHeight;if(document.body)return document.body.clientHeight;return 0;}
function handleResize(){var height=windowHeight()-document.getElementById('toolbar').offsetHeight-45;document.getElementById('map').style.height=height+'px';document.getElementById('sidebar').style.height=(height-18)+'px';}
function validar(form){var validate=checkform(form);if(validate){findRoute();}}
function checkform(form){if(form.initial_point.value==""&&form.end_point.value==""){alert("Debe elegir punto inicial y punto final");return false;}else if(form.initial_point.value==null||form.initial_point.value==""){form.initial_point.focus();alert("Debe elegir un punto inicial");return false;}else if(form.end_point.value==null||form.end_point.value==""){form.end_point.focus();alert("Debe elegir un punto final");return false;}
return true;}
function init(){handleResize();if(GBrowserIsCompatible){var centerLatitude=6.27488;var centerLongitude=-75.56817;var startZoom=16;var lat;var lng;var countInitial=0;var countFinal=0;var point;map=new GMap2(document.getElementById("map"));map.setCenter(new GLatLng(centerLatitude,centerLongitude),startZoom);map.setMapType(G_HYBRID_MAP);map.setUIToDefault();var contextmenu=createContextMenu();map.getContainer().appendChild(contextmenu);document.getElementById('initial_point_func').onclick=function(){getInitialPoint();return false;};document.getElementById('end_point_func').onclick=function(){getFinalPoint();return false;};document.getElementById('zoomin_func').onclick=function(){zoomIn();return false;};document.getElementById('zoomout_func').onclick=function(){zoomOut();return false;};document.getElementById('centerMap_func').onclick=function(){setCenter();return false;};document.getElementById('clearMarkers_func').onclick=function(){clearMarkers();return false;};GEvent.addListener(map,"singlerightclick",function(pixel,tile){var clickedPixel=pixel;var x=pixel.x;var y=pixel.y;if(x>map.getSize().width-120){x=map.getSize().width-120}
if(y>map.getSize().height-100){y=map.getSize().height-100}
var pos=new GControlPosition(G_ANCHOR_TOP_LEFT,new GSize(x,y));pos.apply(contextmenu);contextmenu.style.visibility="visible";point=map.fromContainerPixelToLatLng(clickedPixel);lat=point.lat();lng=point.lng();});function getInitialPoint(){if(countInitial==0){initial_marker=new GMarker(point,{draggable:true});var init_icon=new GIcon();init_icon.image="http://www.google.com/mapfiles/dd-start.png";init_icon.shadow="http://www.google.com/mapfiles/shadow50.png";init_icon.iconSize=new GSize(20,34);init_icon.iconAnchor=new GPoint(9,34);init_icon.shadowSize=new GSize(37,34);init_icon.infoWindowAnchor=new GPoint(24,24);initial_marker=new GMarker(point,{draggable:true,icon:init_icon});map.addOverlay(initial_marker);init_lat=lat;init_lng=lng;document.getElementById("initial_point").value=String(lat).substring(0,7)+','+String(lng).substring(0,9);contextmenu.style.visibility="hidden";countInitial=1;GEvent.addListener(initial_marker,"dragend",function(){init_lat=initial_marker.getPoint().lat();init_lng=initial_marker.getPoint().lng();document.getElementById("initial_point").value=String(init_lat).substring(0,7)+","+String(init_lng).substring(0,9);});}}
function getFinalPoint(){if(countFinal==0){var final_icon=new GIcon();final_icon.image="http://www.google.com/mapfiles/dd-end.png";final_icon.shadow="http://www.google.com/mapfiles/shadow50.png";final_icon.iconSize=new GSize(20,34);final_icon.iconAnchor=new GPoint(9,34);final_icon.shadowSize=new GSize(37,34);final_icon.infoWindowAnchor=new GPoint(24,24);final_marker=new GMarker(point,{draggable:true,icon:final_icon});map.addOverlay(final_marker);end_lat=lat;end_lng=lng;document.getElementById("end_point").value=String(lat).substring(0,7)+','+
String(lng).substring(0,9);contextmenu.style.visibility="hidden";countFinal=1;GEvent.addListener(final_marker,"dragend",function(){end_lat=final_marker.getPoint().lat();end_lng=final_marker.getPoint().lng();document.getElementById("end_point").value=String(end_lat).substring(0,7)+","+String(end_lng).substring(0,9);});}}
function zoomIn(){map.zoomIn();contextmenu.style.visibility="hidden";}
function zoomOut(){map.zoomOut();contextmenu.style.visibility="hidden";}
function setCenter(){map.setCenter(point);}
function clearMarkers(){map.clearOverlays();document.getElementById("initial_point").value='';document.getElementById("end_point").value='';countInitial=0;countFinal=0;contextmenu.style.visibility="hidden";}
GEvent.addListener(map,'click',function(overlay,latlng){contextmenu.style.visibility="hidden";});}else{alert("Your Browser Is Not Compatible")}}
function findRoute(){var init_lat_lng=init_lat+","+init_lng;var end_lat_lng=end_lat+","+end_lng;var bus;var getVars="?initial_point="+init_lat_lng+"&end_point="+end_lat_lng;var request=GXmlHttp.create();request.open('GET','map/find_route'+getVars,true);request.onreadystatechange=function(){if(request.readyState==4){var success=false;var content="Error contacting web service";try{res=eval("("+request.responseText+")");content=res.content;success=res.success;bus=res.bus;route_explain=res.route_explain;bus_explain=res.bus_explain;}catch(e){success=false;}
if(!success){alert(content);$('#sidebar').hide();$('#explain').show();}else{$('#sidebar').show();$('#explain').hide();parseContent(content);createSideBarPannel(route_explain);if(bus==null||bus.length==0){$('#sidebar-bus-list').hide();}else{$('#sidebar-bus-list').show();parseContentBuses(bus);createBusesSidebar(bus_explain);}}}}
request.send(null);return false;}
function parseContentBuses(content,bus_explain){buses_hash={};var size=content.length-1;for(var i=0;i<=size;i++){var id=content[i].id;var bus_id=content[i].bus_id;var lat_start=content[i].lat_start;var long_start=content[i].long_start;var status=content[i].status;buses_hash[i]={id:id,bus_id:bus_id,lat_start:lat_start,long_start:long_start,status:status};}
createBusesOverlays(size);}
function parseContent(content){infoRouteHash={};latlng_street=[];latlng_metro=[];size=content.length;for(var i=0;i<size;i++){var id=content[i].id;var lat_start=content[i].lat_start;var long_start=content[i].long_start;var lat_end=content[i].lat_end;var long_end=content[i].long_end;var stretch_type=content[i].stretch_type;var way_type_a=content[i].way_type_a;var street_name_a=content[i].street_name_a;var prefix_a=content[i].prefix_a;var common_name_a=content[i].common_name_a;var distance=parseFloat(content[i].distance);var label_a=content[i].label_a;var way_type_b=content[i].way_type_b;var street_name_b=content[i].street_name_b;var prefix_b=content[i].prefix_b;var label_b=content[i].label_b;var common_name_b=content[i].common_name_b;var bearing=parseFloat(content[i].bearing);var direction=content[i].direction;var new_direction=content[i].new_direction;var related_id=content[i].related_id;var has_relation=content[i].has_relation;infoRouteHash[i]={id:id,lat_start:lat_start,long_start:long_start,lat_end:lat_end,long_end:long_end,stretch_type:stretch_type,way_type_a:way_type_a,street_name_a:street_name_a,prefix_a:prefix_a,common_name_a:common_name_a,distance:distance,label_a:label_a,way_type_b:way_type_b,street_name_b:street_name_b,prefix_b:prefix_b,label_b:label_b,common_name_b:common_name_b,bearing:bearing,direction:direction,related_id:related_id,new_direction:new_direction,has_relation:has_relation};if(stretch_type=='3'){id_metro_related=id;infoRouteHash[i].related_id=id_metro_related;}
if(stretch_type=='2'){infoRouteHash[i].related_id=id_metro_related;}
latlng_street.push(new GLatLng(lat_start,long_start));if(parseInt(stretch_type)>=2){latlng_metro.push(new GLatLng(lat_start,long_start));}}
latlng_street.push(new GLatLng(lat_end,long_end));document.getElementById("initial_point").value=infoRouteHash[0].way_type_a+' '+infoRouteHash[0].street_name_a;document.getElementById("end_point").value=way_type_b+' '+street_name_b;clearExistingOverlays();setLatLngMarkers(infoRouteHash[0].lat_start,infoRouteHash[0].long_start,infoRouteHash[size-1].lat_end,infoRouteHash[size-1].long_end);drawPolyline(latlng_street,latlng_metro);size_infoHash=Object.size(infoRouteHash);}
Object.size=function(obj){var size=0,key;for(key in obj){if(obj.hasOwnProperty(key))size++;}
return size;};var current_sb_item=false;var arrow_marker;var initial_marker;var final_marker;var route_marker;var polyline;var selected_polyline;var polyline_metro;var polyline_bus;function focusPoint(id){map.addOverlay(polyline);if(selected_polyline){map.removeOverlay(selected_polyline);}
selected_polyline=getSelectedPolyline(id);map.addOverlay(selected_polyline);var current_loc_icon=new GIcon();current_loc_icon.image="http://www.google.com/mapfiles/ms/micons/blue-pushpin.png";current_loc_icon.shadow="http://www.google.com/mapfiles/ms/micons/pushpin_shadow .png";current_loc_icon.iconAnchor=new GPoint(9,34);current_loc_icon.shadowSize=new GSize(37,34);if(route_marker!=null){map.removeOverlay(route_marker);}
var latlng_current_loc=new GLatLng(infoRouteHash[id].lat_start,infoRouteHash[id].long_start);route_marker=new GMarker(latlng_current_loc,{icon:current_loc_icon});map.panTo(latlng_current_loc);map.addOverlay(route_marker);midArrows(id);addClassSidebar('#sidebar-item-',id);}
function focusMetro(id_metro_related){var selected_station=[];map.addOverlay(polyline);for(var i=0;i<size_infoHash;i++){if(infoRouteHash[i].related_id==id_metro_related){selected_station.push(new GLatLng(infoRouteHash[i].lat_start,infoRouteHash[i].long_start));selected_station.push(new GLatLng(infoRouteHash[i].lat_end,infoRouteHash[i].long_end));}}
var polyline_metro=new GPolyline(selected_station);map.addOverlay(polyline_metro);}
function getSelectedPolyline(id){var pointSelectedPolyline=[];var id_related;for(var i=0;i<size_infoHash;i++){id_related=infoRouteHash[id].related_id;if(infoRouteHash[i].related_id==id_related){pointSelectedPolyline.push(new GLatLng(infoRouteHash[i].lat_start,infoRouteHash[i].long_start));pointSelectedPolyline.push(new GLatLng(infoRouteHash[i].lat_end,infoRouteHash[i].long_end));}}
var selectedPolyline=new GPolyline(pointSelectedPolyline,'#FFFFFF',3,0.8);return selectedPolyline;}
function midArrows(id){var last_id;var related_id=infoRouteHash[id].related_id;if(arrow_marker){map.removeOverlay(arrow_marker);}
arrowIcon=new GIcon();arrowIcon.iconSize=new GSize(24,24);arrowIcon.shadowSize=new GSize(1,1);arrowIcon.iconAnchor=new GPoint(12,12);arrowIcon.infoWindowAnchor=new GPoint(0,0);for(var i=0;i<size_infoHash;i++){if(related_id==infoRouteHash[i].related_id){last_id=i;}}
if(infoRouteHash[last_id+1]){var dir=Math.round(infoRouteHash[last_id+1].bearing/3)*3;while(dir>=120){dir-=120;}}
arrowIcon.image="http://www.google.com/intl/en_ALL/mapfiles/dir_"+dir+".png";arrow_marker=new GMarker(new GLatLng(infoRouteHash[last_id].lat_end,infoRouteHash[last_id].long_end),arrowIcon)
map.addOverlay(arrow_marker);}
function drawPolyline(latlng_street,latlng_metro){polyline=new GPolyline(latlng_street,'#FF6633',7,0.8);map.addOverlay(polyline);polyline_metro=new GPolyline(latlng_metro,'#FF6633',4,1);map.addOverlay(polyline_metro);}
function drawSelectedPolyline_bus(checkbox,bus_id){var polyline_bus=getSingleBusPolyline(bus_id,"active");map.addOverlay(polyline_bus);var pos=getOverlayBusesHashPos(bus_id);map.addOverlay(overlay_buses_hash[pos].init_bus_marker);map.addOverlay(overlay_buses_hash[pos].end_bus_marker);addClassSidebarBus('#sidebar-item-bus',bus_id,checkbox,pos);}
function addClassSidebarBus(element,bus_id,checkbox,pos){if(checkbox.checked==false&&$(element+''+bus_id).hasClass('current')){$(element+''+bus_id).removeClass('current');removeSelectedPolyline_bus(bus_id);map.removeOverlay(overlay_buses_hash[pos].init_bus_marker);map.removeOverlay(overlay_buses_hash[pos].end_bus_marker);}else if(checkbox.checked==true){$(element+''+bus_id).addClass('current');}}
function createBusesOverlays(size){var j=0;var latlng_bus=[];for(var i=0;i<size;i++){if(buses_hash[i].bus_id==buses_hash[i+1].bus_id){latlng_bus.push(new GLatLng(buses_hash[i].lat_start,buses_hash[i].long_start));}
else{latlng_bus.push(new GLatLng(buses_hash[i].lat_start,buses_hash[i].long_start));var color='#'+Math.floor(Math.random()*16777215).toString(16);while(color.length<=6){color='#'+Math.floor(Math.random()*16777215).toString(16);}
var polyline_bus=new GPolyline(latlng_bus,color,4,1);var infoMarkers=createMarkersBuses(buses_hash[i].bus_id);overlay_buses_hash[j]={bus_id:buses_hash[i].bus_id,polyline_bus:polyline_bus,init_point_bus:infoMarkers.init_point_bus,end_point_bus:infoMarkers.end_point_bus,init_bus_marker:infoMarkers.init_bus_marker,end_bus_marker:infoMarkers.end_bus_marker};latlng_bus=[];j++;}}}
function createMarkersBuses(bus_id){var init_point_bus;var end_point_bus;var init_bus_marker;var end_bus_marker;var size=Object.size(buses_hash);var bus_icon=new GIcon();bus_icon.image="http://www.google.com/mapfiles/ms/micons/bus.png";bus_icon.shadow="http://www.google.com/mapfiles/ms/micons/bus.shadow.png";bus_icon.iconAnchor=new GPoint(9,34);bus_icon.shadowSize=new GSize(37,34);for(var i=0;i<size;i++){if(bus_id==buses_hash[i].bus_id){var lat_start=buses_hash[i].lat_start;var long_start=buses_hash[i].long_start;init_point_bus=new GLatLng(lat_start,long_start);init_bus_marker=new GMarker(init_point_bus,bus_icon);while(bus_id==buses_hash[i].bus_id){i++;}
var lat_end=buses_hash[i-1].lat_start;var long_end=buses_hash[i-1].long_start;end_point_bus=new GLatLng(lat_end,long_end);end_bus_marker=new GMarker(end_point_bus,bus_icon);}}
return{init_point_bus:init_point_bus,end_point_bus:end_point_bus,init_bus_marker:init_bus_marker,end_bus_marker:end_bus_marker};}
function getSingleBusPolyline(bus_id,status){var size=Object.size(overlay_buses_hash);var polyline_bus;for(var i=0;i<size;i++){if(bus_id==overlay_buses_hash[i].bus_id){polyline_bus=overlay_buses_hash[i].polyline_bus;if(status="active"){overlay_buses_hash[i].status="active";}else{overlay_buses_hash[i].status="inactive";}
break;}}
return polyline_bus;}
function removeSelectedPolyline_bus(bus_id){var polyline_bus=getSingleBusPolyline(bus_id,"inactive");map.removeOverlay(polyline_bus);}
function addClassSidebar(element,id){if($(element+''+current_sb_item).hasClass('current')){$(element+''+current_sb_item).removeClass('current');}$(element+''+id).addClass('current');current_sb_item=id;}
function getOverlayBusesHashPos(bus_id){var size=Object.size(overlay_buses_hash);var pos;for(var i=0;i<size;i++){if(overlay_buses_hash[i].bus_id==bus_id){pos=i;break;}}
return pos;}
function clearExistingOverlays(){var size=Object.size(overlay_buses_hash);if(polyline_metro){map.removeOverlay(polyline_metro);}
if(polyline){map.removeOverlay(polyline);}
if(selected_polyline){map.removeOverlay(selected_polyline);}
if(route_marker){map.removeOverlay(route_marker);}
if(arrow_marker){map.removeOverlay(arrow_marker);}
for(var i=0;i<size;i++){if(overlay_buses_hash[i].status="active"){map.removeOverlay(overlay_buses_hash[i].init_bus_marker);map.removeOverlay(overlay_buses_hash[i].end_bus_marker);removeSelectedPolyline_bus(overlay_buses_hash[i].bus_id);}}}
function setLatLngMarkers(lat_start,long_start,lat_end,long_end){initial_marker.setLatLng(new GLatLng(lat_start,long_start));final_marker.setLatLng(new GLatLng(lat_end,long_end));}
function createBusesSidebar(bus_explain){var div_sidebar_bus_list=document.getElementById("sidebar-bus-list");div_sidebar_bus_list.innerHTML=bus_explain;}
function createSideBarPannel(explain){var div_sidebar_list=document.getElementById("sidebar-list");div_sidebar_list.innerHTML=explain;}
function createContextMenu(){var contextmenu=document.createElement("div");contextmenu.style.visibility="hidden";contextmenu.style.background="#ffffff";contextmenu.style.border="1px solid #8888FF";contextmenu.innerHTML='<a href="javascript:void(0)"  id="initial_point_func"><div class="context">Ruta desde aquí</div></a>'
+'<a href="javascript:void(0)" id="end_point_func"><div class="context">Ruta hasta aquí</div></a>'
+'<hr>'
+'<a href="javascript:void(0)" id="zoomin_func"><div class="context">Zoom In</div></a>'
+'<a href="javascript:void(0)" id="zoomout_func"><div class="context">Zoom Out</div></a>'
+'<a href="javascript:void(0)" id="centerMap_func"><div class="context">Centrar mapa</div></a>'
+'<hr>'
+'<a href="javascript:void(0)" id="clearMarkers_func"><div class="context">Reiniciar origen/destino </div></a>';return contextmenu;}
window.onresize=handleResize;window.onload=handleResize;window.onload=init;
